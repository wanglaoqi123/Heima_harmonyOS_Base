import preferences from '@ohos.data.preferences'
import util from '@ohos.util'

@Entry
@Component
struct WeChat {
  messStore: MessageStore = new MessageStore()
  @State
  @Watch("updateMessage")
  messList: MessageItem[] = []

  async aboutToAppear() {
    this.getMess()
  }

  async updateMessage() {
    await this.messStore.setMessage(JSON.stringify(this.messList))
  }

  async getMess() {
    this.messList = await this.messStore.getMessage()
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        Row() {
          Text('ğŸ±è€å©†å¤§äºº')
            .height(50)
        }
        List() {
          ForEach(this.messList, (item) => {

          })
        }
        .layoutWeight(1)
        .padding({
          bottom: 80
        })


      }


      Row({space : 20}) {
        TextInput()
          .layoutWeight(1)
          .backgroundColor(Color.White)
          .height(40)
          .borderRadius(2)
        Button('å‘é€')
          .height(30)
          .width(60)
      }
      .height(70)
      .width('100%')
      .padding({
        left: 20,
        right: 20
      })
    }
    .height('100%')
    .backgroundColor('#ededed')


  }
}

class MessageItem {
  content: string = "" // èŠå¤©å†…å®¹
  avatar: ResourceStr = "" // ç”¨æˆ·å¤´åƒ
  username: string = "" // ç”¨æˆ·æ˜µç§°
  id: string = "" // æ¶ˆæ¯id
  timestamp: number = 0
  self: boolean = false // æ˜¯å¦æ˜¯è‡ªèº«çš„æ¶ˆæ¯
}

class MessageStore {
  async getStore() {
    return await preferences.getPreferences(getContext(this), "message_store")
  }

  //å†™å…¥æ•°æ®
  async setMessage(json: string) {
    //è·å–é¦–é€‰é¡¹å¯¹è±¡å®ä¾‹
    const store = await this.getStore()
    await store.put("message_list", json) //è®¾ç½®æ•°æ®
    await store.flush() // å°†æ•°æ®å†™å…¥æ•°æ®åº“
  }

  //è·å–æ•°æ®
  async getMessage() {
    //è·å–é¦–é€‰é¡¹å¯¹è±¡å®ä¾‹
    const store = await this.getStore()
    const data = await store.get("message_list", "[]") as string
    return JSON.parse(data) as MessageItem[]
  }
}