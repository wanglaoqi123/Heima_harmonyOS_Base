import preferences from '@ohos.data.preferences'
import util from '@ohos.util'
import promptAction from '@ohos.promptAction'
import http from '@ohos.net.http'
import { WindowMode } from '@ohos.UiTest'

@Entry
@Component
struct WeChat {
  myhttp: http.HttpRequest = http.createHttp()
  @State
  contentStr: string = ""
  messStore: MessageStore = new MessageStore()
  @State
  topY: number = 0
  @State
  @Watch("updateMessage")
  messList: MessageItem[] = []

  async sendMessage() {
    let selfMessage: MessageItem = {
      avatar: $r("app.media.zhan"),
      username: "æœ‰é’±å“¥å“¥",
      id: util.generateRandomUUID(),
      timestamp: Date.now(),
      self: true,
      content: this.contentStr
    }
    this.messList.push(selfMessage) //æ›´æ–°æ•°ç»„  -> é¦–é€‰é¡¹ä¹Ÿæ›´æ–°

    //å‘é€è¯·æ±‚
    const url = "http://api.qingyunke.com/api.php?key=free&appid=0&msg=${encodeURI(this.contentStr)}"
    this.contentStr = "" //æˆ‘å‘æˆ‘çš„ï¼Œæˆ‘æ¸…æˆ‘çš„
    const res = await this.myhttp.request(url)
    //æ‹¿åˆ°æœºå™¨äººå›å¤çš„ç»“æœ
    const result = JSON.parse(res.result as string) as ResultClass
    if (result.result === 0) {
      //å†åŠ ä¸€æ¡èŠå¤©è®°å½•
      let wifeMessage: MessageItem = {
        avatar: $r("app.media.bo"),
        username: "åšå¼Ÿ",
        id: util.generateRandomUUID(),
        timestamp: Date.now(),
        self: false,
        content: result.content
      }
      this.messList.push(wifeMessage)
    }

  }

  async aboutToAppear() {
    this.getMess()
  }

  async updateMessage() {
    await this.messStore.setMessage(JSON.stringify(this.messList))
  }

  async getMess() {
    this.messList = await this.messStore.getMessage()
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        Row() {
          Text('ğŸ±è€å©†å¤§äºº')
            .height(50)
        }
        //èŠå¤©å¯¹è¯æ¡†
        //å¾ªç¯èŠå¤©è®°å½•
        List({ space: 20 }) {
          ForEach(this.messList, (item: MessageItem) => {
            //èŠå¤©ä¿¡æ¯ç»„ä»¶
            ListItem() {
              MessageChat({ item, delMesssage: (id: string) => {
                const index = this.messList.findIndex(item => item.id === id)
                this.messList.splice(index,1)
              } })
            }
          })
        }
        .layoutWeight(1)
        .padding({
          bottom: 80
        })
      }
      .position({
        y: this.topY
      })

      Row({ space: 20 }) {
        TextInput({
          text: this.contentStr
        })
          .layoutWeight(1)
          .backgroundColor(Color.White)
          .height(40)
          .borderRadius(2)
          .onChange(value => {
            this.contentStr = value
          })
        Button('å‘é€')
          .height(30)
          .width(60)
          .enabled(!!this.contentStr) //!!è¡¨ç¤ºå°†å­—ç¬¦ä¸²è½¬æˆå¸ƒå°”ç±»å‹
          .onClick(() => {
            //å‘é€æ¶ˆæ¯
            this.sendMessage()
          })
      }
      .height(70)
      .width('100%')
      .padding({
        left: 20,
        right: 20
      })
    }
    .height('100%')
    .backgroundColor('#ededed')
    .onAreaChange((oldArea: Area, newArea: Area) => {
      this.topY = Math.abs(parseFloat(newArea.globalPosition.y.toString()))
    })
  }
}

@Component
struct MessageChat {
  item: Partial<MessageItem> = {}
  @State
  showDel: boolean = false
  delMesssage: (id: string) => void = () => {}

  @Builder
  getDelContent () {
    Button('åˆ é™¤')
      .onClick(() => {
        this.delMesssage(this.item.id)
      })
  }

  build() {
    Row() {
      Image(this.item.avatar)
        .width(40)
        .aspectRatio(1)
        .borderRadius(6)
      Row() {
        Text(this.item.content)
          .fontColor('#0c2803')
          .backgroundColor(this.item.self ? "#8bec73" : Color.White)
          .lineHeight(24)
          .padding(10)
          .margin({
            left: 10,
            right: 10
          })
          .gesture(LongPressGesture()
            .onAction(() => {
              this.showDel = true
            }))
          // .bindPopup(this.showDel, {
          //   builder: this.getDelContent(),
          //   placement: Placement.Top
          // })
        if (this.showDel) {
          this.getDelContent()
        }
      }
      .layoutWeight(5)
      .justifyContent(this.item.self ? FlexAlign.End : FlexAlign.Start)

      Text().layoutWeight(1)
    }
    .padding({
      left: 20,
      right: 20
    })
    .width('100%')
    .direction(this.item.self ? Direction.Rtl : Direction.Ltr)
  }
}

class MessageItem {
  content: string = "" // èŠå¤©å†…å®¹
  avatar: ResourceStr = "" // ç”¨æˆ·å¤´åƒ
  username: string = "" // ç”¨æˆ·æ˜µç§°
  id: string = "" // æ¶ˆæ¯id
  timestamp: number = 0
  self: boolean = false // æ˜¯å¦æ˜¯è‡ªèº«çš„æ¶ˆæ¯
}

class MessageStore {
  async getStore() {
    return await preferences.getPreferences(getContext(this), "message_store")
  }

  //å†™å…¥æ•°æ®
  async setMessage(json: string) {
    //è·å–é¦–é€‰é¡¹å¯¹è±¡å®ä¾‹
    const store = await this.getStore()
    await store.put("message_list", json) //è®¾ç½®æ•°æ®
    await store.flush() // å°†æ•°æ®å†™å…¥æ•°æ®åº“
  }

  //è·å–æ•°æ®
  async getMessage() {
    //è·å–é¦–é€‰é¡¹å¯¹è±¡å®ä¾‹
    const store = await this.getStore()
    const data = await store.get("message_list", "[]") as string
    return JSON.parse(data) as MessageItem[]
  }
}

class ResultClass {
  result: number = 0
  content: string = ""
}

